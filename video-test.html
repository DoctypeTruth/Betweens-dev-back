<!DOCTYPE html>
<html>

<head>
  <title>Chat vidéo</title>
</head>

<body>
  <video id="local-video" autoplay></video>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io('http://localhost:5000');
    const roomTemp = 'toto'; // Remplacez par le nom de votre salle

    // Spécifiez l'URL de la vidéo que vous souhaitez utiliser
    const videoUrl = '/video';

    // Création d'une nouvelle instance de connexion RTCPeerConnection
    const peerConnection = new RTCPeerConnection();

    // Création d'un élément vidéo pour afficher le flux vidéo
    const videoElement = document.getElementById('local-video');

    // Chargement de la vidéo à partir de l'URL spécifiée
    videoElement.src = videoUrl;

    // Ajout du flux vidéo à la connexion RTCPeerConnection
    videoElement.addEventListener('loadedmetadata', () => {
      const stream = videoElement.captureStream();
      stream.getTracks().forEach((track) => {
        peerConnection.addTrack(track, stream);

        console.log('Video metadata loaded')
      });



      // Événement de réception d'un nouveau candidat ICE
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          // Envoyer le candidat ICE au serveur via Socket.IO
          socket.emit('iceCandidate', { roomTemp, iceCandidate: event.candidate });
          console.log('iceCandidate', { roomTemp, iceCandidate: event.candidate });

        }

      };

      // Événement de réception d'une offre (offer) du serveur
      socket.on('offer', (offer) => {
        console.log('Received demande:', offer)
        // Définir la description distante (remote description) de la connexion RTCPeerConnection
        peerConnection.setRemoteDescription(offer)
          .then(() => {
            // Créer une réponse (answer)
            return peerConnection.createAnswer();
          })
          .then((answer) => {
            // Définir la description locale (local description) de la connexion RTCPeerConnection
            return peerConnection.setLocalDescription(answer);
          })
          .then(() => {
            // Envoyer la réponse au serveur via Socket.IO
            console.log("emit answer")
            socket.emit('answer', { roomTemp, answer: peerConnection.localDescription });
          })
          .catch((error) => {
            console.error('Erreur lors de la création de la réponse :', error);
          });
      });

      // Événement de réception d'une réponse (answer) du serveur
      socket.on('answer', (answer) => {

        console.log('Received answer:', answer)
        // Définir la description distante (remote description) de la connexion RTCPeerConnection
        peerConnection.setRemoteDescription(answer)
          .catch((error) => {
            console.error('Erreur lors de la définition de la description distante :', error);
          });
      });

      // Événement de réception d'un candidat ICE du serveur
      socket.on('iceCandidate', (iceCandidate) => {
        console.log('Received ICE candidate:', iceCandidate)
        // Ajouter le candidat ICE reçu à la connexion RTCPeerConnection
        peerConnection.addIceCandidate(iceCandidate)
          .catch((error) => {
            console.error('Erreur lors de l\'ajout du candidat ICE :', error);
          });
      });

      // Créer une nouvelle offre (offer)
      peerConnection.createOffer()
        .then((offer) => {
          // Définir la description locale (local description) de la connexion RTCPeerConnection
          return peerConnection.setLocalDescription(offer);
        })
        .then(() => {
          // Envoyer l'offre au serveur via Socket.IO
          console.log("emit demand")
          socket.emit('offer', { roomTemp, offer: peerConnection.localDescription });
        })
        .catch((error) => {
          console.error('Erreur lors de la création de l\'offre :', error);
        });
    });
  </script>
</body>

</html>